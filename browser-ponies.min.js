"use strict"
if("object"!=typeof BrowserPonies){!function(){var e=function(e,t){for(var i in t)i in e||(e[i]=t[i])}
e(String.prototype,{trim:function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},trimLeft:function(){return this.replace(/^\s\s*/,"")},trimRight:function(){return this.replace(/\s\s*$/,"")}}),e(Array,{isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)}}),e(Array.prototype,{indexOf:function(e,t){for((!t||0>t)&&(t=0);t<this.length;++t)if(this[t]===e)return t
return-1}}),e(Function.prototype,{bind:function(e){var t=this,i=Array.prototype.slice.call(arguments,1)
return function(){return t.apply(e,i.concat(Array.prototype.slice.call(arguments)))}}}),e(Date,{now:function(){return(new Date).getTime()}}),"undefined"==typeof console&&e(window,{console:{}}),e(window.console,{log:function(){}}),e(window.console,{info:window.console.log,warn:window.console.log,error:window.console.log,trace:window.console.log,dir:window.console.log})}()
var BrowserPonies=function(){var e=9e6,t=document.addEventListener?function(e,t,i){e.addEventListener(t,i,!1)}:function(e,t,i){var n="_eventHandlingWrapper"in i?i._eventHandlingWrapper:i._eventHandlingWrapper=function(){var e=window.event
return"stopPropagation"in e||(e.stopPropagation=function(){this.cancelBubble=!0}),"preventDefault"in e||(e.preventDefault=function(){this.returnValue=!1}),"target"in e||(e.target=e.srcElement),i.call(this,e)}
e.attachEvent("on"+t,n)},i=document.removeEventListener?function(e,t,i){e.removeEventListener(t,i,!1)}:function(e,t,i){"_eventHandlingWrapper"in i&&e.detachEvent("on"+t,i._eventHandlingWrapper)},n=function(){for(var e=["hidden","webkitHidden","mozHidden","msHidden"],t=0;t<e.length;++t){var i=e[t]
if(i in document)return document[i]}return!1},r=function(){null!==Me&&(n()?clearTimeout(Me):(le=Date.now(),ce()))}
void 0!==document.hidden?t(document,"visibilitychange",r):void 0!==document.webkitHidden?t(document,"webkitvisibilitychange",r):void 0!==document.mozHidden?t(document,"mozvisibilitychange",r):void 0!==document.msHidden&&t(document,"msvisibilitychange",r)
var o="innerWidth"in window?function(){return{width:window.innerWidth,height:window.innerHeight}}:function(){return{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}},s=function(e,t,i,n){return e.length>=t?e:(i=Array(t-e.length+1).join(i),n?i+e:e+i)},a=function(e){for(var t="",i=1;e;){var n=/^([^%]*)%(-)?(0)?(\d+)?(?:\.(\d+)?)?([dfesj%])(.*)$/.exec(e)
if(!n){t+=e
break}t+=n[1],e=n[7]
var r="-"!==n[2],o=n[4]?parseInt(n[4]):0,a=n[5]?parseInt(n[5]):6,h=r?n[3]||" ":" "
switch(n[6]){case"d":t+=s(parseInt(arguments[i++]).toFixed(0),o,h,r)
break
case"f":t+=s((+arguments[i++]).toFixed(a),o,h,r)
break
case"e":t+=s((+arguments[i++]).toExponential(a),o,h,r)
break
case"s":t+=s(arguments[i++]+"",o," ",r)
break
case"j":t+=s(JSON.stringify(arguments[i++]),o," ",r)
break
case"%":t+=s("%",o," ",r)}}return t},h=function(e,t){for(var i in t)e[i]=t[i]
return e},l=function(e){var t=Array.prototype.slice.call(arguments,1)
return function(){return e.apply(this,t.concat(Array.prototype.slice.call(arguments)))}},c=function Ce(e){var t=Ce.abs(e),i=Ce.FILE_REGEX.exec(t)
if(i||(i=Ce.NET_REGEX.exec(t)),!i)throw new URIError("Illegal URL: "+e)
this.protocol=i[1].toLowerCase(),this.username=i[2],this.password=i[3],this.hostname=i[4],this.port=i[5],this.pathname=i[6]||"/",this.search=i[7]||"",this.hash=i[8]||"",this.port||(this.port=Ce.DEFAULT_PORTS[this.protocol]),this.port&&Ce.DEFAULT_PORTS[this.protocol]!==this.port?this.host=this.hostname+":"+this.port:this.host=this.hostname}
c.prototype={toString:function(){return this.protocol+"//"+(this.username||this.password?(this.username||"anonymous")+(this.password?":"+this.password:"")+"@":"")+this.hostname+(this.port&&R4.URL.DEFAULT_PORTS[this.protocol]!==this.port?":"+this.port:"")+this.pathname+this.search+this.hash}},h(c,{FILE_REGEX:/^(file:)\/\/()()()()([^#\?]*)(\?[^#]*)?(#.*)?$/i,NET_REGEX:/^([a-z][-_a-z0-9]*:)\/\/(?:([^:@\/]*)(?::([^:@\/]*))?@)?([^:@\/]*)(?::(\d+))?(?:(\/[^#\?]*)(\?[^#]*)?(#.*)?)?$/i,DEFAULT_PORTS:{"http:":"80","https:":"443","ftp:":"21","ftps:":"990","file:":""},abs:function(e,t){if(t||(t=window.location),"//"===e.slice(0,2))return t.protocol+e
if("/"===e[0])return t.protocol+"//"+t.host+e
if("#"===e[0])return t.protocol+"//"+t.host+t.pathname+t.search+e
if("?"===e[0])return t.protocol+"//"+t.host+t.pathname+e
if(/^[a-z][-_a-z0-9]*:/i.test(e))return e
var i=t.pathname.split("/")
return i.pop(),0===i.length&&i.push(""),i.push(e),t.protocol+"//"+t.host+i.join("/")},join:function(e){for(var t=0;t<arguments.length;++t){var i=arguments[t];/^[a-z][-_a-z0-9]*:/i.test(i)?e=i:(e=new c(e),e="//"===i.slice(0,2)?e.protocol+i:"/"===i[0]?e.protocol+"//"+e.host+i:"#"===i[0]?e.protocol+"//"+e.host+e.pathname+e.search+i:"?"===i[0]?e.protocol+"//"+e.host+e.pathname+i:e.protocol+"//"+e.host+e.pathname+i)}return c.fix(e)},fix:function(e){return e.replace(/^https?:\/\/web\d?\.student\.tuwien\.ac\.at\/~e0427417\/browser-ponies\//,"https://panzi.github.com/Browser-Ponies/")}})
var u,p,f="[object Opera]"===Object.prototype.toString.call(window.opera)
!function(){var e=/MSIE ([0-9]{1,}[\.0-9]{0,})/.exec(navigator.userAgent)
if(u=!!e){p=e[1].split(".")
for(var t=0;t<p.length;++t)p[t]=parseInt(p[t],10)}}()
var d=navigator.userAgent.indexOf("Gecko")>-1&&-1===navigator.userAgent.indexOf("KHTML"),g="undefined"!=typeof Audio,v=function(e,i){if(i)if("string"==typeof i)e.appendChild(document.createTextNode(i))
else if(Array.isArray(i))for(var n=0,r=i.length;r>n;++n)v(e,i[n])
else if(1===i.nodeType||3===i.nodeType)e.appendChild(i)
else for(var o in i){var s=i[o]
if("class"===o||"className"===o)e.className=s+""
else if("for"===o||"htmlFor"===o)e.htmlFor=s+""
else if(/^on/.test(o)){if("function"!=typeof s)throw Error("Event listeners must be a function.")
t(e,o.replace(/^on/,""),s)}else if("style"===o)if("object"==typeof s)for(var a in s){var h=s[a]
if("float"===a)e.style.cssFloat=h,e.style.styleFloat=h
else if("opacity"===a)m(e,+h)
else try{e.style[a]=h}catch(l){console.error(a+"="+h+" "+l)}}else e.style.cssText+=";"+s
else"value"===o&&"TEXTAREA"===e.nodeName?e.value=s:s===!0?e.setAttribute(o,o):s===!1?e.removeAttribute(o):e.setAttribute(o,s+"")}},m=u&&p[0]<10?function(e,t){try{e.style.filter=e.style.filter.replace(/\balpha\([^\)]*\)/gi,"")+"alpha(opacity="+100*+t+")"}catch(i){}e.style.opacity=t}:function(e,t){e.style.opacity=t},y=function(e){for(var t=document.createElement(e),i=1,n=arguments.length;n>i;++i)v(t,arguments[i])
return t},b=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},w=function(e,t){for(var i=0;i<e.length;)e[i]===t?e.splice(i,1):++i},_=function(e,t){return"data:"+e+";base64,"+k.encode(t)},x=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},k={encode:function(e){return btoa(unescape(encodeURIComponent(e)))},decode:function(e){return decodeURIComponent(escape(atob(e)))}},L={parse:function(e){for(var t=e.split(/\r?\n/),i=[],n=0,r=t.length;r>n;++n){var o=t[n].trim()
if(0!==o.length&&"'"!==o.charAt(0)){var s=[]
o=this.parseLine(o,s),0!==o.length&&console.error("trailing text:",o),i.push(s)}}return i},parseLine:function(e,t){for(var i;(e=e.trimLeft()).length>0;){var n=e.charAt(0)
switch(n){case'"':e=e.slice(1),i=e.search('"'),0>i&&(i=e.length),t.push(e.slice(0,i)),e=e.slice(i),e.length>0?(n=e.charAt(0),'"'===n&&(e=e.slice(1).trimLeft(),n=e.charAt(0)),e.length>0&&(","===n?e=e.slice(1):"}"!==n&&console.error("data after quoted string:",e))):console.error("unterminated quoted string")
break
case",":e=e.slice(1),t.push("")
break
case"{":var r=[]
t.push(r),e=this.parseLine(e.slice(1),r).trimLeft(),e.length>0?(n=e.charAt(0),"}"!==n?console.error("data after list:",e):(e=e.slice(1).trimLeft(),n=e.charAt(0)),","===n&&(e=e.slice(1))):console.error("unterminated list")
break
case"}":case"\n":return e
default:i=e.search(/[,}]/),0>i&&(i=e.length),t.push(e.slice(0,i).trim()),e=e.slice(i),e.length>0&&(n=e.charAt(0),","===n?e=e.slice(1):"}"!==n&&console.error("syntax error:",e))}}return e}},z=function(e){var t=e.trim().toLowerCase()
if("true"===t)return!0
if("false"===t)return!1
throw Error("illegal boolean value: "+e)},M=function(e){if("string"==typeof e&&(e=e.split(",")),2!==e.length||!/^\s*-?\d+\s*$/.test(e[0])||!/^\s*-?\d+\s*$/.test(e[1]))throw Error("illegal point value: "+e.join(","))
return{x:parseInt(e[0],10),y:parseInt(e[1],10)}},R=function(e){return"string"==typeof e?document.getElementById(e):e&&1===e.nodeType?e:null},I=function(e,t){var i=t.x-e.x,n=t.y-e.y
return Math.sqrt(i*i+n*n)},D=function(e){return e[Math.floor(e.length*Math.random())]},P={Left:0,Right:1,Up:2,Down:3,UpLeft:4,UpRight:5,DownLeft:6,DownRight:7},A={None:0,HorizontalOnly:1,VerticalOnly:2,HorizontalVertical:3,DiagonalOnly:4,DiagonalHorizontal:5,DiagonalVertical:6,All:7,MouseOver:8,Sleep:9,Dragged:10},C={Top:0,Bottom:1,Left:2,Right:3,BottomRight:4,BottomLeft:5,TopRight:6,TopLeft:7,Center:8,Any:9,AnyNotCenter:10},N={wav:"audio/wav",webm:"audio/webm",mpeg:"audio/mpeg",mpga:"audio/mpeg",mpg:"audio/mpeg",mp1:'audio/mpeg;codecs="mp1"',mp2:'audio/mpeg;codecs="mp2"',mp3:'audio/mpeg;codecs="mp3"',mp4:"audio/mp4",mp4a:"audio/mp4",ogg:"audio/ogg",oga:"audio/ogg",flac:'audio/ogg;codecs="flac"',spx:'audio/ogg;codecs="speex"'},B=function(e){this.name=e.name,this.probability=e.probability,this.proximity="default"===e.proximity?640:e.proximity,this.activate=e.activate,this.delay=e.delay,this.targets=[],this.behaviors=[]
for(var t=0,i=e.behaviors.length;i>t;++t)this.behaviors.push(e.behaviors[t].toLowerCase())
for(var t=0,i=e.targets.length;i>t;++t){var n=e.targets[t].toLowerCase()
if(b(xe,n)){for(var r=xe[n],o=0;o<this.behaviors.length;){var s=this.behaviors[o]
b(r.behaviors_by_name,s)?++o:this.behaviors.splice(o,1)}this.targets.push(r)}else console.warn("Interaction "+this.name+" of pony "+e.pony+" references non-existing pony "+n)}}
B.prototype={reachableTargets:function(e){var t=[],i=this.targets.length
if(0===i)return t
for(var n=0;i>n;++n){for(var r=this.targets[n],o=null,s=1/0,a=0,h=r.instances.length;h>a;++a){var l=r.instances[a],c=I(e,l.position())
c<=this.proximity&&s>c&&(o=l,s=c)}if(o)t.push([s,o])
else if("all"===this.activate)return null}if(0===t.length)return null
if("one"===this.activate)return t.sort(function(e,t){return e[0]-t[0]}),[t[0][1]]
for(var n=0;n<t.length;++n)t[n]=t[n][1]
return t}}
var S=function(e,t){if(h(this,t),!this.name||"none"===this.name.toLowerCase())throw Error(e+": illegal behavior name "+this.name)
this.follow&&(this.follow=this.follow.toLowerCase()),this.movement=null
var i=t.movement.replace(/[-_\s]/g,"").toLowerCase()
for(var n in A)if(n.toLowerCase()===i){this.movement=A[n]
break}if(null===this.movement)throw Error(e+": illegal movement "+t.movement+" for behavior "+t.name)
if(this.rightsize={width:0,height:0},t.rightimage&&(this.rightimage=c.join(e,t.rightimage)),this.leftsize={width:0,height:0},t.leftimage&&(this.leftimage=c.join(e,t.leftimage)),(!this.rightcenter||0===this.rightcenter.x&&0===this.rightcenter.y)&&(this.rightcenter={x:0,y:0,missing:!0}),(!this.leftcenter||0===this.leftcenter.x&&0===this.leftcenter.y)&&(this.leftcenter={x:0,y:0,missing:!0}),this.effects=[],this.effects_by_name={},"effects"in t)for(var r=0,o=t.effects.length;o>r;++r){var s=new E(e,t.effects[r])
this.effects_by_name[s.name.toLowerCase()]=s,this.effects.push(s)}}
S.prototype={deref:function(e,t){var i=this[e],n=(i||"").toLowerCase()
i&&"none"!==n?b(t.behaviors_by_name,n)?this[e]=t.behaviors_by_name[n]:(console.warn(a("%s: Behavior %s of pony %s references non-existing behavior %s.",t.baseurl,this.name,t.name,i)),delete this[e]):delete this[e]},preload:function(){for(var e=0,t=this.effects.length;t>e;++e)this.effects[e].preload()
this.rightimage&&$(this.rightimage,function(e){this.rightsize.width=e.width,this.rightsize.height=e.height,this.rightcenter.missing&&(this.rightcenter={x:Math.round(.5*e.width),y:Math.round(.5*e.height)})}.bind(this)),this.leftimage&&$(this.leftimage,function(e){this.leftsize.width=e.width,this.leftsize.height=e.height,this.leftcenter.missing&&(this.leftcenter={x:Math.round(.5*e.width),y:Math.round(.5*e.height)})}.bind(this))},isMoving:function(){if(this.follow||this.x||this.x)return!0
switch(this.movement){case A.None:case A.MouseOver:case A.Sleep:return!1
default:return!0}}}
var T=function(e){var t=e.replace(/[-_\s]/g,"").toLowerCase()
for(var i in C)if(i.toLowerCase()===t)return C[i]
throw Error("illegal location: "+e)},E=function(e,t){h(this,t),this.name=t.name.toLowerCase()
for(var i=["rightloc","leftloc","rightcenter","leftcenter"],n=0;n<i.length;++n){var r=i[n]
r in t&&(this[r]=T(t[r]))}this.rightsize={width:0,height:0},t.rightimage&&(this.rightimage=c.join(e,t.rightimage)),this.rightcenter_point={x:0,y:0},this.leftsize={width:0,height:0},t.leftimage&&(this.leftimage=c.join(e,t.leftimage)),this.leftcenter_point={x:0,y:0}}
E.prototype={preload:function(){this.rightimage&&$(this.rightimage,function(e){this.rightsize.width=e.width,this.rightsize.height=e.height,this.rightcenter_point={x:Math.round(.5*e.width),y:Math.round(.5*e.height)}}.bind(this)),this.leftimage&&$(this.leftimage,function(e){this.leftsize.width=e.width,this.leftsize.height=e.height,this.leftcenter_point={x:Math.round(.5*e.width),y:Math.round(.5*e.height)}}.bind(this))}}
var U=function(e,t){for(var i=Math.min(e.length,t.length),n=0;i>n;++n)if(e.charAt(n)!==t.charAt(n))return n
return i},O={},F=0,H=0,j=[],V=[],W=function(e,i,n){var r=e.object=new Image
t(r,"load",l(n,!0)),t(r,"error",l(n,!1)),t(r,"abort",l(n,!1)),r.src=i},q=function(e){var t=new Audio
if("string"==typeof e)t.src=e
else for(var i in e){var n=y("source",{src:e[i]})
"audio/x-unknown"!==i&&(n.type=i),t.appendChild(n)}return t},X=function(e){return function(i,n,r){var o=i.object=q(e)
t(o,"loadeddata",l(r,!0)),t(o,"error",l(r,!1)),t(o,"abort",l(r,!1)),o.preload="auto"}},$=function(e,t){K(W,e,t)},G=function(e,t){var i
if("string"==typeof e)i=e
else{var n=[]
for(var r in e)n.push(e[r])
if(0===n.length)throw Error("no audio url to preload")
if(1===n.length)i=n[0]
else{for(var o=n[0],s=1;s<n.length;++s){var a=U(o,n[s])
a!==o.length&&(o=o.slice(0,a))}for(var s=0;s<n.length;++s)n[s]=n[s].slice(o.length)
n.sort(),i=o+"{"+n.join("|")+"}"}}K(X(e),i,t)},K=function(e,t,i){if(b(O,t)){if(i){var n=O[t]
n.loaded?i(n.object):n.callbacks.push(i)}}else{++F
var n=O[t]={loaded:!1,callbacks:i?[i]:[]}
e(n,t,function(e){if(n.loaded)return void console.error("resource loaded twice: "+t)
n.loaded=!0,++H,e?console.log(a("%3.0f%% %d of %d loaded: %s",100*H/F,H,F,t)):console.error(a("%3.0f%% %d of %d load error: %s",100*H/F,H,F,t))
for(var i=0,r=V.length;r>i;++i)V[i](H,F,t,e)
for(var i=0,r=n.callbacks.length;r>i;++i)n.callbacks[i](n.object,e)
if(delete n.callbacks,H===F){for(var i=0,r=j.length;r>i;++i)j[i]()
j=[]}})}}
K(function(e,n,r){if(document.body)r(!0)
else{var o=!1,s=function(){o||(o=!0,r(!0))}
if(document.addEventListener)t(document,"DOMContentLoaded",s)
else{var a=function(){"complete"===document.readyState&&(i(document,"readystatechange",a),s())}
t(document,"readystatechange",a)}t(window,"load",s)}},document.location.href)
var Y=function(e){H===F?e():j.push(e)},J=function(e){V.push(e)},Z=0,Q=null,ee=function(){Z=H,document.body.appendChild(Q.container),te(),setTimeout(function(){Q&&!Q.finished&&(Q.container.style.display="")},250),t(window,"resize",te),i(window,"load",ee)},te=function(){var e=o(),t=!1
"none"===Q.container.style.display&&(t=!0,Q.container.style.visibility="hidden",Q.container.style.display="")
var i=Q.container.offsetWidth,n=Q.container.offsetHeight,r=Q.label.offsetHeight
t&&(Q.container.style.display="none",Q.container.style.visibility=""),Q.container.style.left=Math.round(.5*(e.width-i))+"px",Q.container.style.top=Math.round(.5*(e.height-n))+"px",Q.label.style.top=Math.round(.5*(n-r))+"px"}
J(function(e,n){if(fe||Q){Q||(Q={bar:y("div",{style:{margin:"0",padding:"0",borderStyle:"none",width:"0",height:"100%",background:"#9BD6F4",MozBorderRadius:"5px",borderRadius:"5px"}}),label:y("div",{style:{position:"absolute",margin:"0",padding:"0",borderStyle:"none",top:"0px",left:"0px",width:"100%",textAlign:"center"}})},Q.barcontainer=y("div",{style:{margin:"0",padding:"0",borderStyle:"none",width:"100%",height:"100%",background:"#D8D8D8",MozBorderRadius:"5px",borderRadius:"5px"}},Q.bar),Q.container=y("div",{style:{position:"fixed",width:"450px",height:"30px",background:"white",padding:"10px",margin:"0",MozBorderRadius:"5px",borderRadius:"5px",color:"#294256",fontWeight:"bold",fontSize:"16px",opacity:"0.9",display:"none",boxShadow:"2px 2px 12px rgba(0,0,0,0.4)",MozBoxShadow:"2px 2px 12px rgba(0,0,0,0.4)"},onclick:function(){Q&&(Q.container.style.display="none")}},Q.barcontainer,Q.label)),"none"===Q.container.style.display&&(Z=e),Q.finished=e===n
var r=e-Z,o=n-Z,s=0===o?1:r/o
Q.bar.style.width=Math.round(450*s)+"px",Q.label.innerHTML=a("Loading Ponies&hellip; %d%%",Math.floor(100*s)),Q.container.parentNode||(document.body?ee():t(window,"load",ee)),Q.finished&&setTimeout(function(){i(window,"resize",te),i(window,"load",ee),Q&&Q.container&&Q.container.parentNode&&Q.container.parentNode.removeChild(Q.container),Q=null},500)}})
var ie=function(e){if(this.baseurl=c.join(ve,e.baseurl||""),!e.name)throw Error("pony with following base URL has no name: "+this.baseurl)
if(this.name=e.name,this.behaviorgroups=e.behaviorgroups||{},this.all_behaviors=[],this.random_behaviors=[],this.mouseover_behaviors=[],this.dragged_behaviors=[],this.stand_behaviors=[],this.behaviors_by_name={},this.speeches=[],this.random_speeches=[],this.speeches_by_name={},this.interactions=[],this.instances=[],this.categories=[],e.categories)for(var t=0,i=e.categories.length;i>t;++t)this.categories.push(e.categories[t].toLowerCase())
if(e.speeches)for(var t=0,i=e.speeches.length;i>t;++t){var n=h({},e.speeches[t])
if(n.files){var r=0
for(var o in n.files)n.files[o]=c.join(this.baseurl,n.files[o]),++r
0===r&&delete n.files}if(n.name){var s=n.name.toLowerCase()
b(this.speeches_by_name,s)?console.warn(a("%s: Speech name %s of pony %s is not unique.",this.baseurl,n.name,e.name)):this.speeches_by_name[s]=n}"skip"in n||(n.skip=!1),n.skip||this.random_speeches.push(n),"group"in n?0===n.group||b(this.behaviorgroups,n.group)||console.warn(a("%s: Speech %s references unknown behavior group %d.",this.baseurl,n.name,n.group)):n.group=0,this.speeches.push(n)}var l=["speakstart","speakend"]
if("behaviors"in e){for(var t=0,i=e.behaviors.length;i>t;++t){var u=new S(this.baseurl,e.behaviors[t]),s=u.name.toLowerCase()
b(this.behaviors_by_name,s)?console.warn(a("%s: Behavior name %s of pony %s is not unique.",this.baseurl,u.name,e.name)):this.behaviors_by_name[s]=u
for(var p=0;p<l.length;++p){var f=l[p],d=u[f]
d&&(d=d.toLowerCase(),b(this.speeches_by_name,d)?u[f]=this.speeches_by_name[d]:(console.warn(a("%s: Behavior %s of pony %s references non-existing speech %s.",this.baseurl,u.name,e.name,u[f])),delete u[f]))}switch(this.all_behaviors.push(u),"skip"in u||(u.skip=!1),u.skip||this.random_behaviors.push(u),u.movement){case A.MouseOver:this.mouseover_behaviors.push(u),u.skip||this.stand_behaviors.push(u)
break
case A.Dragged:this.dragged_behaviors.push(u),u.skip||this.stand_behaviors.push(u)
break
case A.None:u.skip||this.stand_behaviors.push(u)}"group"in u?0===u.group||b(this.behaviorgroups,u.group)||console.warn(a("%s: Behavior %s references unknown behavior group %d.",this.baseurl,u.name,u.group)):u.group=0}if(0===this.dragged_behaviors.length&&this.mouseover_behaviors.length>0&&(this.dragged_behaviors=this.mouseover_behaviors.slice()),0===this.stand_behaviors.length)for(var t=0,i=this.all_behaviors.length;i>t;++t){var u=this.all_behaviors[t]
u.movement!==A.Sleep||u.skip||this.stand_behaviors.push(u)}0===this.stand_behaviors.length?console.warn(a("%s: Pony %s has no (non-skip) non-moving behavior.",this.baseurl,this.name)):0===this.mouseover_behaviors.length&&(this.mouseover_behaviors=this.stand_behaviors.slice())
for(var t=0,i=this.all_behaviors.length;i>t;++t){var u=this.all_behaviors[t]
u.deref("linked",this),u.deref("stopped",this),u.deref("moving",this)}}}
ie.prototype={preload:function(){for(var e=0,t=this.all_behaviors.length;t>e;++e)this.all_behaviors[e].preload()
if(g&&de)for(var e=0,t=this.speeches.length;t>e;++e){var i=this.speeches[e]
i.files&&G(i.files)}},unspawnAll:function(){for(;this.instances.length>0;)this.instances[0].unspawn()},addInteraction:function(e){if(e=new B(e),0===e.targets.length)return console.warn("Dropping interaction "+e.name+" of pony "+this.name+" because it has no targets."),!1
for(var t=0;t<e.behaviors.length;){var i=e.behaviors[t]
b(this.behaviors_by_name,i)?++t:e.behaviors.splice(t,1)}return 0===e.behaviors.length?(console.warn("Dropping interaction "+e.name+" of pony "+this.name+" because it has no common behaviors."),!1):(this.interactions.push(e),!0)}}
var ne=function(e){return re(e,o())},re=function(e,t){var i=.5*e.width,n=.5*e.height
return e.x<i||e.y<n||e.x+i>t.width||e.y+n>t.height},oe=function(e){var t=o(),i=e.x,n=e.y,r=.5*e.width,s=.5*e.height
return r>i?i=r:i+r>t.width&&(i=t.width-r),s>n?n=s:n+s>t.height&&(n=t.height-s),{x:Math.round(i),y:Math.round(n)}},se=function(){}
se.prototype={setTopLeftPosition:function(t){this.current_position.x=t.x+this.current_center.x,this.current_position.y=t.y+this.current_center.y,this.img.style.left=Math.round(t.x)+"px",this.img.style.top=Math.round(t.y)+"px"
var i=Math.round(e+t.y+this.current_size.height)
this.zIndex!==i&&(this.img.style.zIndex=i)},setPosition:function(t){var i=this.current_position.x=t.x,n=this.current_position.y=t.y,r=Math.round(n-this.current_center.y)
this.img.style.left=Math.round(i-this.current_center.x)+"px",this.img.style.top=r+"px"
var o=Math.round(e+r+this.current_size.height)
this.zIndex!==o&&(this.img.style.zIndex=o)},moveBy:function(e){this.setPosition({x:this.current_position.x+e.x,y:this.current_position.y+e.y})},clipToScreen:function(){this.setPosition(oe(this.rect()))},topLeftPosition:function(){return{x:this.current_position.x-this.current_center.x,y:this.current_position.y-this.current_center.y}},position:function(){return this.current_position},size:function(){return this.current_size},rect:function(){var e=this.current_position
return e.width=this.current_size.width,e.height=this.current_size.height,e},topLeftRect:function(){var e=this.topLeftPosition(),t=this.size()
return{x:e.x,y:e.y,width:t.width,height:t.height}},isOffscreen:function(){return ne(this.rect())}}
var ae=function(e){this.pony=e,this.img=this.createImage(),this.clear()}
ae.prototype=h(new se,{createImage:function(){var t=function(e){if(e.preventDefault(),!(e.touches.length>1||"touchend"===e.type&&e.touches.length>0)){var t=document.createEvent("MouseEvents"),i=null,n=null
switch(e.type){case"touchstart":i="mousedown",n=e.changedTouches[0]
break
case"touchmove":i="mousemove",n=e.changedTouches[0]
break
case"touchend":i="mouseup",n=e.changedTouches[0]}t.initMouseEvent(i,!0,!0,e.target.ownerDocument.defaultView,1,n.screenX,n.screenY,n.clientX,n.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null),e.target.dispatchEvent(t)}}
return y("img",{draggable:"false",style:{position:"fixed",userSelect:"none",borderStyle:"none",margin:"0",padding:"0",backgroundColor:"transparent",zIndex:e+""},ondragstart:function(e){e.preventDefault()},ontouchstart:t,ontouchmove:t,ontouchend:t,ondblclick:function(){var e=this.position(),t=(this.end_time-this.start_time)/1e3
console.log(a("%s does %s%s for %.2f seconds, is at %d x %d and %s. See:",this.pony.name,this.current_behavior.name,this.current_behavior===this.paint_behavior?"":" using "+this.paint_behavior.name,t,e.x,e.y,this.following?"follows "+this.following.name():a("wants to go to %d x %d",this.dest_position.x,this.dest_position.y)),this)}.bind(this),onmousedown:function(e){("buttons"in e?1&e.buttons:u?1&e.button:0===e.button)&&(Ie=this,this.mouseover=!0,null!==Me&&this.nextBehavior(!0),e.preventDefault())}.bind(this),onmouseover:function(){this.mouseover||(this.mouseover=!0,null===Me||this.isMouseOverOrDragging()||!this.canMouseOver()&&!this.canDrag()||this.nextBehavior(!0))}.bind(this),onmouseout:function(e){e.target
this.mouseover&&(this.mouseover=!1)}.bind(this)})},isMouseOverOrDragging:function(){return this.current_behavior&&(this.current_behavior.movement===A.MouseOver||this.current_behavior.movement===A.Dragged)},canDrag:function(){if(this.current_behavior){for(var e=this.current_behavior.group,t=0,i=this.pony.dragged_behaviors.length;i>t;++t){var n=this.pony.dragged_behaviors[t]
if(0===n.group||n.group===e)return!0}return!1}return this.pony.dragged_behaviors.length>0},canMouseOver:function(){if(this.current_behavior){for(var e=this.current_behavior.group,t=0,i=this.pony.mouseover_behaviors.length;i>t;++t){var n=this.pony.mouseover_behaviors[t]
if(0===n.group||n.group===e)return!0}return!1}return this.pony.mouseover_behaviors.length>0},name:function(){return this.pony.name},unspawn:function(){var e=Date.now()
if(this.effects)for(var t=0,i=this.effects.length;i>t;++t)Le.push({at:e,element:this.effects[t].img})
Le.push({at:e,element:this.img}),w(this.pony.instances,this),w(ke,this)},clear:function(){if(this.effects)for(var t=0,i=this.effects.length;i>t;++t)this.effects[t].clear()
this.img.parentNode&&this.img.parentNode.removeChild(this.img),this.mouseover=!1,this.start_time=null,this.end_time=null,this.current_interaction=null,this.interaction_targets=null,this.current_imgurl=null,this.interaction_wait=0,this.current_position={x:0,y:0},this.dest_position={x:0,y:0},this.current_size={width:0,height:0},this.current_center={x:0,y:0},this.zIndex=e,this.current_behavior=null,this.paint_behavior=null,this.facing_right=!0,this.end_at_dest=!1,this.effects=[],this.repeating=[]},interact:function(e,t,i){var n,r=D(t.behaviors)
this.behave(this.pony.behaviors_by_name[r])
for(var o=0,s=i.length;s>o;++o)n=i[o],n.behave(n.pony.behaviors_by_name[r]),n.current_interaction=t
this.current_interaction=t,this.interaction_targets=i},speak:function(t,i){if(!be){if(i.text){var n=Math.max(150*i.text.length,1e3),r={at:t+n},o=y("div",{ondblclick:function(){r.at=Date.now()},style:{fontSize:"14px",color:"#294256",background:u?"white":"rgba(255,255,255,0.8)",position:"fixed",visibility:"hidden",margin:"0",padding:"4px",maxWidth:"250px",textAlign:"center",borderRadius:"10px",MozBorderRadius:"10px",width:"auto",height:"auto",boxShadow:"2px 2px 12px rgba(0,0,0,0.4)",MozBoxShadow:"2px 2px 12px rgba(0,0,0,0.4)",zIndex:e+9e3+""}},i.text)
r.element=o
var s=this.topLeftRect()
Ae().appendChild(o)
var a=Math.round(s.x+.5*s.width-.5*o.offsetWidth),h=s.y+s.height
o.style.left=a+"px",o.style.top=h+"px",o.style.visibility="",Le.push(r),o=null}if(g&&de&&i.files){var l=q(i.files)
l.volume=Pe,l.play()}}},update:function(e,t,i){var n,r=this.rect(),o=null
this.following?this.following.img.parentNode?(o=this.dest_position,o.x=this.following.current_position.x,this.following.facing_right?o.x+=this.current_behavior.x-this.following.paint_behavior.rightcenter.x:o.x+=-this.current_behavior.x+this.following.paint_behavior.leftcenter.x,o.y=this.following.current_position.y+this.current_behavior.y,n=I(r,o),!this.current_behavior.x&&!this.current_behavior.y&&n<=.5*r.width&&(o=null)):this.following=null:(o=this.dest_position,o&&(n=I(r,o)))
var s
if(o){var a=o.x-r.x,h=o.y-r.y,l=this.current_behavior.speed*t*.01*me
if(l>=n)s=o
else{var c=l/n
s={x:Math.round(r.x+c*a),y:Math.round(r.y+c*h)}}s.x!==o.x?this.setFacingRight(s.x<=o.x):this.following&&(this.current_behavior.auto_select_images||(0===Math.round(l)?this.current_behavior.stopped&&(this.paint_behavior=this.current_behavior.stopped):this.current_behavior.moving&&(this.paint_behavior=this.current_behavior.moving)),this.setFacingRight(this.following.facing_right)),this.setPosition(s)}else s=r
for(var u=0;u<this.effects.length;){var p=this.effects[u]
p.update(e,t,i)?++u:(this.effects.splice(u,1),Le.push({element:p.img,at:e}))}for(var u=0,f=this.repeating.length;f>u;++u){var d=this.repeating[u]
if(d.at<=e){var g=new he(this,e,d.effect)
ze.appendChild(g.img),g.updatePosition(e,0),this.effects.push(g),d.at+=1e3*d.effect.delay}}if(this.interaction_wait<=e&&this.pony.interactions.length>0&&!this.current_interaction){for(var v=0,m=[],y=null,u=0,f=this.pony.interactions.length;f>u;++u){y=this.pony.interactions[u]
var b=y.reachableTargets(r)
b&&(v+=y.probability,m.push([y,b]))}if(m.length>0){for(var w=Math.random()*v,_=0,u=0,f=m.length;f>u&&(y=m[u],_+=y.probability,!(_>=w));++u);if(w=Math.random()*(100/_e),w<=y[0].probability)return void this.interact(e,y[0],y[1])}this.interaction_wait+=_e}if(e>=this.end_time||this.end_at_dest&&this.dest_position.x===s.x&&this.dest_position.y===s.y)return void this.nextBehavior()
if(!this.following){var x=this.current_center.x,k=this.current_center.y,L=this.current_size.width-x,z=this.current_size.height-k,M=s.x-x,R=s.x+L,D=s.y-k,P=s.y+z
0>=M?this.dest_position.x<s.x&&(this.dest_position.x=Math.round(Math.max(s.x+s.x-this.dest_position.x,x))):R>=i.width&&this.dest_position.x>s.x&&(this.dest_position.x=Math.round(Math.min(s.x+s.x-this.dest_position.x,i.width-L))),0>=D?this.dest_position.y<s.y&&(this.dest_position.y=Math.round(Math.max(s.y+s.y-this.dest_position.y,k))):P>=i.height&&this.dest_position.y>s.y&&(this.dest_position.y=Math.round(Math.min(s.y+s.y-this.dest_position.y,i.height-z)))}},getNearestInstance:function(e){var t=[],i=this.position(),n=xe[e]
if(n)for(var r=0,o=n.instances.length;o>r;++r){var s=n.instances[r]
this.loops(s)||t.push([I(i,s.position()),s])}else for(var r=0,o=ke.length;o>r;++r){var s=ke[r]
if(!this.loops(s))for(var a=0,h=s.effects.length;h>a;++a){var l=s.effects[a]
l.effect.name===e&&t.push([I(i,l.position()),l])}}return 0===t.length?null:(t.sort(function(e,t){return e[0]-t[0]}),t[0][1])},nextBehavior:function(e){var t=this.isOffscreen()
if(!e&&this.current_behavior&&this.current_behavior.linked)this.behave(this.current_behavior.linked,t)
else{if(this.current_interaction){var i=Date.now()
if(this.interaction_wait=i+1e3*this.current_interaction.delay,this.interaction_targets){for(var n=0,r=this.interaction_targets.length;r>n;++n)this.interaction_targets[n].interaction_wait=this.interaction_wait
this.interaction_targets=null}this.current_interaction=null}this.behave(this.randomBehavior(t),t)}},setFacingRight:d?function(e){this.facing_right=e
var t
if(e?(t=this.paint_behavior.rightimage,this.current_size=this.paint_behavior.rightsize,this.current_center=this.paint_behavior.rightcenter):(t=this.paint_behavior.leftimage,this.current_size=this.paint_behavior.leftsize,this.current_center=this.paint_behavior.leftcenter),t!==this.current_imgurl){var i=this.createImage()
i.style.left=this.img.style.left,i.style.top=this.img.style.top,i.style.zIndex=this.img.style.zIndex,i.src=this.current_imgurl=t,this.img.parentNode.replaceChild(i,this.img),this.img=i}}:function(e){this.facing_right=e
var t
e?(t=this.paint_behavior.rightimage,this.current_size=this.paint_behavior.rightsize,this.current_center=this.paint_behavior.rightcenter):(t=this.paint_behavior.leftimage,this.current_size=this.paint_behavior.leftsize,this.current_center=this.paint_behavior.leftcenter),t!==this.current_imgurl&&(this.img.src=this.current_imgurl=t)},behave:function(e,t){this.start_time=Date.now()
var i=e.minduration+(e.maxduration-e.minduration)*Math.random()
this.end_time=this.start_time+1e3*i
var n=this.current_behavior
this.current_behavior=this.paint_behavior=e
for(var r=[],s=0,a=this.effects.length;a>s;++s){var l=this.effects[s]
l.effect.duration?r.push(l):Le.push({element:l.img,at:this.start_time})}this.facing_right?(this.current_size=this.paint_behavior.rightsize,this.current_center=this.paint_behavior.rightcenter):(this.current_size=this.paint_behavior.leftsize,this.current_center=this.paint_behavior.leftcenter)
var c=!1
n&&n.speakend&&(this.speak(this.start_time,n.speakend),c=!0),this.following=null,e.follow&&(this.following=this.getNearestInstance(e.follow)),e.speakstart?this.speak(this.start_time,e.speakstart):c||this.following||this.current_interaction||this.speakRandom(this.start_time,ye)
var u=this.position(),p=this.size(),f=o()
if(this.end_at_dest=!1,this.following)this.dest_position.x=this.following.current_position.x,this.dest_position.y=this.following.current_position.y
else if(e.follow||!e.x&&!e.y){var d=null
switch(e.movement){case A.HorizontalOnly:d=[P.Left,P.Right]
break
case A.VerticalOnly:d=[P.Up,P.Down]
break
case A.HorizontalVertical:d=[P.Left,P.Right,P.Up,P.Down]
break
case A.DiagonalOnly:d=[P.UpLeft,P.UpRight,P.DownLeft,P.DownRight]
break
case A.DiagonalHorizontal:d=[P.Left,P.Right,P.UpLeft,P.UpRight,P.DownLeft,P.DownRight]
break
case A.DiagonalVertical:d=[P.Up,P.Down,P.UpLeft,P.UpRight,P.DownLeft,P.DownRight]
break
case A.All:d=[P.Left,P.Right,P.Up,P.Down,P.UpLeft,P.UpRight,P.DownLeft,P.DownRight]}if(null===d)this.dest_position.x=Math.round(u.x),this.dest_position.y=Math.round(u.y)
else{var g=u.y-.5*p.height<100,v=u.y+.5*p.height+100>f.height,m=u.x-.5*p.width<100,y=u.x+.5*p.width+100>f.width,b=d.slice()
g&&(w(b,P.Up),w(b,P.UpLeft),w(b,P.UpRight)),v&&(w(b,P.Down),w(b,P.DownLeft),w(b,P.DownRight)),m&&(w(b,P.Left),w(b,P.UpLeft),w(b,P.DownLeft)),y&&(w(b,P.Right),w(b,P.UpRight),w(b,P.DownRight))
var _,x=e.speed*i*100*me
switch(D(0===b.length?d:b)){case P.Up:this.dest_position={x:u.x,y:u.y-x}
break
case P.Down:this.dest_position={x:u.x,y:u.y+x}
break
case P.Left:this.dest_position={x:u.x-x,y:u.y}
break
case P.Right:this.dest_position={x:u.x+x,y:u.y}
break
case P.UpLeft:_=Math.sqrt(x*x*.5),this.dest_position={x:u.x-_,y:u.y-_}
break
case P.UpRight:_=Math.sqrt(x*x*.5),this.dest_position={x:u.x+_,y:u.y-_}
break
case P.DownLeft:_=Math.sqrt(x*x*.5),this.dest_position={x:u.x-_,y:u.y+_}
break
case P.DownRight:_=Math.sqrt(x*x*.5),this.dest_position={x:u.x+_,y:u.y+_}}t?(this.dest_position=oe(h(this.dest_position,p)),this.end_at_dest=!0):(this.dest_position.x=Math.round(this.dest_position.x),this.dest_position.y=Math.round(this.dest_position.y))}}else this.end_at_dest=!0,this.dest_position={x:Math.round((f.width-p.width)*(e.x||0)/100),y:Math.round((f.height-p.height)*(e.y||0)/100)}
this.setFacingRight(u.x!==this.dest_position.x?u.x<=this.dest_position.x:this.facing_right),this.setPosition(this.current_position)
var k=Ae()
this.repeating=[]
for(var s=0,a=e.effects.length;a>s;++s){var L=e.effects[s],l=new he(this,this.start_time,L)
k.appendChild(l.img),l.updatePosition(this.start_time,0),r.push(l),L.delay&&this.repeating.push({effect:L,at:this.start_time+1e3*L.delay})}this.effects=r},teleport:function(){var e=o(),t=this.size()
this.setTopLeftPosition({x:Math.random()*(e.width-t.width),y:Math.random()*(e.height-t.height)})},speakRandom:function(e,t){if(!(Math.random()>=t)){for(var i=[],n=this.current_behavior.group,r=0,o=this.pony.random_speeches.length;o>r;++r){var s=this.pony.random_speeches[r];(0===s.group||s.group===n)&&i.push(s)}i.length>0&&this.speak(e,D(i))}},randomBehavior:function(e){var t,i=this.current_behavior?this.current_behavior.group:0
t=this===Ie&&this.canDrag()?this.pony.dragged_behaviors:this.mouseover&&this.canMouseOver()?this.pony.mouseover_behaviors:this.pony.random_behaviors
for(var n=0,r=[],o=0,s=t.length;s>o;++o){var a=t[o];(!e||a.isMoving())&&(0===i||0===a.group||a.group===i)&&(n+=a.probability,r.push(a))}for(var h=Math.random()*n,l=0,o=0,s=r.length;s>o;++o){var a=r[o]
if(l+=a.probability,l>=h)return a}return e?this.randomBehavior(!1):null},loops:function(e){for(;e;){if(this===e)return!0
e=e.following}return!1}})
var he=function(t,i,n){this.pony=t,this.start_time=i
var r=1e3*n.duration
d&&(r*=.6),r=Math.max(r-ue,ue),this.end_time=i+r,this.effect=n
var o
t.facing_right?(o=this.effect.rightimage,this.current_size=this.effect.rightsize,this.current_center=this.effect.rightcenter_point):(o=this.effect.leftimage,this.current_size=this.effect.leftsize,this.current_center=this.effect.leftcenter_point),this.current_position={x:0,y:0},this.zIndex=e,this.current_imgurl=null,this.img=this.createImage(o)
for(var s=["rightloc","rightcenter","leftloc","leftcenter"],a=0,h=s.length;h>a;++a){var l=s[a],c=n[l]
c===C.Any?c=D([C.Top,C.Bottom,C.Left,C.Right,C.BottomRight,C.BottomLeft,C.TopRight,C.TopLeft,C.Center]):c===C.AnyNotCenter&&(c=D([C.Top,C.Bottom,C.Left,C.Right,C.BottomRight,C.BottomLeft,C.TopRight,C.TopLeft])),this[l]=c}}
he.prototype=h(new se,{createImage:function(t){var i=y(d||f?"img":"iframe",{src:t,draggable:"false",style:{position:"fixed",overflow:"hidden",userSelect:"none",pointerEvents:"none",borderStyle:"none",margin:"0",padding:"0",backgroundColor:"transparent",width:this.current_size.width+"px",height:this.current_size.height+"px",zIndex:e+""}})
return u&&(i.setAttribute("scrolling","no"),i.setAttribute("frameborder","0"),i.setAttribute("marginheight","0"),i.setAttribute("marginwidth","0")),i},name:function(){return this.effect.name},clear:function(){this.img.parentNode&&this.img.parentNode.removeChild(this.img)},updatePosition:function(){var e,t
this.pony.facing_right?(e=this.rightloc,t=this.rightcenter):(e=this.leftloc,t=this.leftcenter)
var i,n=this.size()
switch(t){case C.Top:i={x:.5*-n.width,y:0}
break
case C.Bottom:i={x:.5*-n.width,y:-n.height}
break
case C.Left:i={x:0,y:.5*-n.height}
break
case C.Right:i={x:-n.width,y:.5*-n.height}
break
case C.BottomRight:i={x:-n.width,y:-n.height}
break
case C.BottomLeft:i={x:0,y:-n.height}
break
case C.TopRight:i={x:-n.width,y:0}
break
case C.TopLeft:i={x:0,y:0}
break
case C.Center:i={x:.5*-n.width,y:.5*-n.height}}var r=this.pony.topLeftRect()
switch(e){case C.Top:i.x+=r.x+.5*r.width,i.y+=r.y
break
case C.Bottom:i.x+=r.x+.5*r.width,i.y+=r.y+r.height
break
case C.Left:i.x+=r.x,i.y+=r.y+.5*r.height
break
case C.Right:i.x+=r.x+r.width,i.y+=r.y+.5*r.height
break
case C.BottomRight:i.x+=r.x+r.width,i.y+=r.y+r.height
break
case C.BottomLeft:i.x+=r.x,i.y+=r.y+r.height
break
case C.TopRight:i.x+=r.x+r.width,i.y+=r.y
break
case C.TopLeft:i.x+=r.x,i.y+=r.y
break
case C.Center:i.x+=r.x+.5*r.width,i.y+=r.y+.5*r.height}this.setTopLeftPosition(i)},setImage:d?function(e){if(this.current_imgurl!==e){var t=this.createImage(e)
t.style.left=this.img.style.left,t.style.top=this.img.style.top,t.style.zIndex=this.img.style.zIndex,this.current_imgurl=e,this.img.parentNode.replaceChild(t,this.img),this.img=t}}:function(e){this.current_imgurl!==e&&(this.img.src=this.current_imgurl=e,this.img.style.width=this.current_size.width+"px",this.img.style.height=this.current_size.height+"px")},update:function(e,t){if(this.effect.follow){this.updatePosition(e,t)
var i
this.pony.facing_right?(i=this.effect.rightimage,this.current_size=this.effect.rightsize,this.current_center=this.effect.rightcenter_point):(i=this.effect.leftimage,this.current_size=this.effect.leftsize,this.current_center=this.effect.leftcenter_point),this.setImage(i)}return!this.effect.duration||e<this.end_time}})
var le=Date.now(),ce=function(){if(null!==Me){for(var t=Date.now(),i=t-le,n=o(),r=0,s=ke.length;s>r;++r)ke[r].update(t,i,n)
for(var r=0;r<Le.length;){var a=Le[r]
a.at+ue<=t?(a.element.parentNode&&a.element.parentNode.removeChild(a.element),Le.splice(r,1)):(a.at<=t&&m(a.element,1-(t-a.at)/ue),++r)}if(ge){if(!De){var h=Ae()
De=y("div",{style:{fontSize:"18px",position:"fixed",bottom:"0",left:"0",zIndex:e+9001+""}}),h.appendChild(De)}De.innerHTML=Math.round(1e3/i)+" fps"}Me=setTimeout(ce,Math.max(we-(t-Date.now()),0)),le=t}},ue=500,pe=!1,fe=!0,de=!1,ge=!1,ve=c.abs(""),me=3,ye=.1,be=!1,we=40,_e=500,xe={},ke=[],Le=[],ze=null,Me=null,Re=null,Ie=null,De=null,Pe=1,Ae=function(){return ze||(ze=y("div",{id:"browser-ponies"})),ze.parentNode||document.body.appendChild(ze),ze}
return t(document,"touchstart",function(){Re=null}),t(document,"mousemove",function(e){Re||(Re={x:e.clientX,y:e.clientY}),Ie&&(Ie.moveBy({x:e.clientX-Re.x,y:e.clientY-Re.y}),h(Ie.dest_position,Ie.current_position),e.preventDefault()),Re.x=e.clientX,Re.y=e.clientY}),t(document,"mouseup",function(){if(Ie){var e=Ie
Ie=null,null!==Me&&e.nextBehavior()}}),{convertPony:function(e,t){for(var i=L.parse(e),n={baseurl:t||"",behaviorgroups:{},behaviors:[],speeches:[],categories:[]},r={},o=[],s=0,a=i.length;a>s;++s){var h=i[s],l=h[0].toLowerCase()
switch(l){case"name":n.name=h[1]
break
case"behaviorgroup":var c=parseInt(h[1],10)
isNaN(c)?console.warn(t+": illegal behavior group id: ",h[1]):n.behaviorgroups[c]=h[2]
break
case"behavior":var u={name:h[1],probability:+h[2],maxduration:+h[3],minduration:+h[4],speed:+h[5],rightimage:encodeURIComponent(h[6]),leftimage:encodeURIComponent(h[7]),movement:h[8],effects:[],auto_select_images:!0,dont_repeat_animation:!1}
if(h.length>9){h[9]&&(u.linked=h[9])
var p=(h[10]||"").trim()
p&&(u.speakstart=p)
var f=(h[11]||"").trim()
f&&(u.speakend=f),u.skip=z(h[12]),u.x=+h[13],u.y=+h[14],h[15]&&(u.follow=h[15]),h.length>16&&(u.auto_select_images=z(h[16]),h[17]&&(u.stopped=h[17]),h[18]&&(u.moving=h[18]),h.length>19&&(u.rightcenter=M(h[19]),u.leftcenter=M(h[20]),h.length>21&&(u.dont_repeat_animation=z(h[21]),u.dont_repeat_animation&&console.warn(t+": behavior "+u.name+" sets dont_repeat_animation to true, which is not supported by Browser Ponies due to limitations in browsers. Please use a GIF that does not loop instead."),h[22]&&(u.group=parseInt(h[22],10),isNaN(u.group)&&(delete u.group,console.warn(t+": behavior "+u.name+" references illegal behavior group id: ",h[22]))))))}n.behaviors.push(u),r[u.name.toLowerCase()]=u
break
case"effect":var d={name:h[1],behavior:h[2],rightimage:encodeURIComponent(h[3]),leftimage:encodeURIComponent(h[4]),duration:+h[5],delay:+h[6],rightloc:h[7].trim(),rightcenter:h[8].trim(),leftloc:h[9].trim(),leftcenter:h[10].trim(),follow:z(h[11]),dont_repeat_animation:h[12]?z(h[12]):!1}
d.dont_repeat_animation&&console.warn(t+": effect "+d.name+" sets dont_repeat_animation to true, which is not supported by Browser Ponies due to limitations in browsers. Please use a GIF that does not loop instead."),o.push(d)
break
case"speak":var g
if(2===h.length)g={text:h[1]}
else{g={name:h[1],text:h[2].trim()},h[4]&&(g.skip=z(h[4])),h[5]&&(g.group=parseInt(h[5],10))
var v=h[3]
if(v&&(Array.isArray(v)||(v=[v]),v.length>0)){g.files={}
for(var m=0;m<v.length;++m){var y,w=v[m],_=/(?:\.([^\.]*))?$/.exec(w)[1]
_?(_=_.toLowerCase(),y=N[_]||"audio/x-"+_):y="audio/x-unknown",y in g.files&&console.warn(t+": file type "+y+" of speak line "+g.name+" is not unique."),g.files[y]=encodeURIComponent(w)}}"group"in g&&isNaN(g.group)&&(delete g.group,console.warn(t+": speak line "+g.name+" references illegal behavior group id: ",h[5]))}n.speeches.push(g)
break
case"categories":n.categories=n.categories.concat(h.slice(1))
break
default:console.warn(t+": Unknown pony setting:",h)}}if(!("name"in n))throw Error("Pony with following base URL has no name: "+n.baseurl)
for(var s=0,a=o.length;a>s;++s){var d=o[s],u=d.behavior.toLowerCase()
b(r,u)?(r[u].effects.push(d),delete d.behavior):console.warn(t+": Effect "+d.name+" of pony "+n.name+" references non-existing behavior "+d.behavior)}for(var x in r){var u=r[x]
0===u.effects.length&&delete u.effects}var k=!1
for(var R in n.behaviorgroups){k=!0
break}return k||delete n.behaviorgroups,n},convertInteractions:function(e){for(var t=L.parse(e),i=[],n=0,r=t.length;r>n;++n){var o=t[n],s="one"
if(o.length>4)if(s=o[5].trim().toLowerCase(),"true"===s||"all"===s)s="all"
else if("random"==s||"any"===s)s="any"
else{if("false"!==s&&"one"!==s)throw Error("illegal target activation value: "+o[5])
s="one"}var a=o[3].trim().toLowerCase()
"default"!==a&&(a=+a),i.push({name:o[0],pony:o[1],probability:+o[2],proximity:a,targets:o[4],activate:s,behaviors:o[6],delay:o.length>7?+o[7].trim():0})}return i},addInteractions:function(e){"string"==typeof e&&(e=this.convertInteractions(e))
for(var t=0,i=e.length;i>t;++t)this.addInteraction(e[t])},addInteraction:function(e){var t=e.pony.toLowerCase()
return b(xe,t)?xe[t].addInteraction(e):(console.error("No such pony:",e.pony),!1)},addPonies:function(e){for(var t=0,i=e.length;i>t;++t)this.addPony(e[t])},addPony:function(e){if(e.ini&&(e=this.convertPony(e.ini,e.baseurl)),0===e.behaviors.length)return console.error("Pony "+e.name+" has no behaviors."),!1
var t=e.name.toLowerCase()
return b(xe,t)?(console.error("Pony "+e.name+" already exists."),!1):(xe[t]=new ie(e),!0)},removePonies:function(e){for(var t=0,i=e.length;i>t;++t)this.removePony(e[t])},removePony:function(e){var t=e.toLowerCase()
b(xe,t)&&(xe[t].unspawnAll(),delete xe[t])},spawnRandom:function(e){if(e=void 0===e?1:parseInt(e),isNaN(e))return console.error("unexpected NaN value"),[]
for(var t=[];e>0;){var i=1/0
for(var n in xe){var r=xe[n].instances.length
i>r&&(i=r)}if(i===1/0){console.error("can't spawn random ponies because there are no ponies loaded")
break}var o=[]
for(var n in xe)xe[n].instances.length===i&&o.push(n)
var n=D(o)
this.spawn(n)&&t.push(n),--e}return t},spawn:function(e,t){var i=e.toLowerCase()
if(!b(xe,i))return console.error("No such pony:",e),!1
var n=xe[i]
if(void 0===t)t=1
else if(t=parseInt(t),isNaN(t))return console.error("unexpected NaN value"),!1
t>0&&null!==Me&&n.preload()
for(var r=t;r>0;){var o=new ae(n)
n.instances.push(o),null!==Me?Y(function(){-1!==this.pony.instances.indexOf(this)&&(ke.push(this),this.img.style.visibility="hidden",Ae().appendChild(this.img),this.teleport(),this.nextBehavior(),this.clipToScreen(),this.img.style.visibility="")}.bind(o)):ke.push(o),--r}return!0},unspawn:function(e,t){var i=e.toLowerCase()
if(!b(xe,i))return console.error("No such pony:",e),!1
var n=xe[i]
if(void 0===t)t=n.instances.length
else if(t=parseInt(t),isNaN(t))return console.error("unexpected NaN value"),!1
if(t>=n.instances.length)n.unspawnAll()
else for(;t>0;)n.instances[n.instances.length-1].unspawn(),--t
return!0},unspawnAll:function(){for(var e in xe)xe[e].unspawnAll()},clear:function(){this.unspawnAll(),xe={}},preloadAll:function(){for(var e in xe)xe[e].preload()},preloadSpawned:function(){for(var e in xe){var t=xe[e]
t.instances.length>0&&t.preload()}},start:function(){pe?this.preloadAll():this.preloadSpawned(),Y(function(){var e=Ae()
e.innerHTML=""
for(var t=0,i=ke.length;i>t;++t){var n=ke[t]
n.clear(),n.img.style.visibility="hidden",e.appendChild(n.img),n.teleport(),n.nextBehavior(),n.clipToScreen(),n.img.style.visibility=""}null===Me&&(le=Date.now(),Me=setTimeout(ce,0))})},timer:function(){return Me},stop:function(){ze&&(ze.parentNode.removeChild(ze),ze.innerHTML="",ze=null),De=null,null!==Me&&(clearTimeout(Me),Me=null)},pause:function(){null!==Me&&(clearTimeout(Me),Me=null)},resume:function(){pe?this.preloadAll():this.preloadSpawned(),Y(function(){null===Me&&(le=Date.now(),Me=setTimeout(ce,0))})},setInterval:function(e){e=parseInt(e),isNaN(e)?console.error("unexpected NaN value for interval"):we!==e&&(we=e)},getInterval:function(){return we},setFps:function(e){this.setInterval(1e3/+e)},getFps:function(){return 1e3/we},setInteractionInterval:function(e){e=+e,isNaN(e)?console.error("unexpected NaN value for interaction interval"):_e=e},getInteractionInterval:function(){return _e},setSpeakProbability:function(e){e=+e,isNaN(e)?console.error("unexpected NaN value for speak probability"):ye=e},getSpeakProbability:function(){return ye},setDontSpeak:function(e){be=!!e},isDontSpeak:function(){return be},setVolume:function(e){e=+e,isNaN(e)?console.error("unexpected NaN value for volume"):0>e||e>1?console.error("volume out of range",e):Pe=e},getVolume:function(){return Pe},setBaseUrl:function(e){ve=c.fix(e)},getBaseUrl:function(){return ve},setSpeed:function(e){me=+e},getSpeed:function(){return me},setAudioEnabled:function(e){if("string"==typeof e)try{e=z(e)}catch(t){return void console.error("illegal value for audio enabled",e,t)}else e=!!e
de!==e&&e?(de=e,pe?this.preloadAll():this.preloadSpawned()):de=e},isAudioEnabled:function(){return de},setShowFps:function(e){if("string"==typeof e)try{ge=z(e)}catch(t){return void console.error("illegal value for show fps",e,t)}else ge=!!e
!ge&&De&&(De.parentNode&&De.parentNode.removeChild(De),De=null)},isShowFps:function(){return ge},setPreloadAll:function(e){if("string"==typeof e)try{pe=z(e)}catch(t){return void console.error("illegal value for preload all",e,t)}else pe=!!e},isPreloadAll:function(){return pe},setShowLoadProgress:function(e){if("string"==typeof e)try{fe=z(e)}catch(t){return void console.error(t)}else fe=!!e},isShowLoadProgress:function(){return fe},getFadeDuration:function(){return ue},setFadeDuration:function(e){ue=+e},running:function(){return null!==Me},ponies:function(){return xe},loadConfig:function(e){if("baseurl"in e&&this.setBaseUrl(e.baseurl),"speed"in e&&this.setSpeed(e.speed),"speakProbability"in e&&this.setSpeakProbability(e.speakProbability),"dontSpeak"in e&&this.setDontSpeak(e.dontSpeak),"volume"in e&&this.setVolume(e.volume),"interval"in e&&this.setInterval(e.interval),"fps"in e&&this.setFps(e.fps),"interactionInterval"in e&&this.setInteractionInterval(e.interactionInterval),"audioEnabled"in e&&this.setAudioEnabled(e.audioEnabled),"showFps"in e&&this.setShowFps(e.showFps),"preloadAll"in e&&this.setPreloadAll(e.preloadAll),"showLoadProgress"in e&&this.setShowLoadProgress(e.showLoadProgress),"fadeDuration"in e&&this.setFadeDuration(e.fadeDuration),e.ponies&&this.addPonies(e.ponies),e.interactions&&this.addInteractions(e.interactions),e.spawn)for(var t in e.spawn)this.spawn(t,e.spawn[t])
if("spawnRandom"in e&&this.spawnRandom(e.spawnRandom),e.onload)if(Array.isArray(e.onload))for(var i=0,n=e.onload.length;n>i;++i)Y(e.onload[i])
else Y(e.onload)
e.autostart&&null===Me&&this.start()},dumpConfig:function(){var e={}
e.baseurl=this.getBaseUrl(),e.speed=this.getSpeed(),e.speakProbability=this.getSpeakProbability(),e.dontSpeak=this.isDontSpeak(),e.volume=this.getVolume(),e.interval=this.getInterval(),e.fps=this.getFps(),e.interactionInterval=this.getInteractionInterval(),e.audioEnabled=this.isAudioEnabled(),e.showFps=this.isShowFps(),e.preloadAll=this.isPreloadAll(),e.showLoadProgress=this.isShowLoadProgress(),e.fadeDuration=this.getFadeDuration(),e.spawn={}
for(var t in xe){var i=xe[t]
i.instances.length>0&&(e.spawn[i.name]=i.instances.length)}return e},togglePoniesToBackground:function(){if("undefined"==typeof toggleBrowserPoniesToBackground)alert("This website does not support bringing Browser Ponies to the background.")
else try{toggleBrowserPoniesToBackground()}catch(e){alert("Error toggling Browser Ponies to the background:\n\n"+e.name+": "+e.message)}},Util:{setOpacity:m,extend:h,tag:h(y,{add:v}),has:b,format:a,partial:l,observe:t,stopObserving:i,IE:u,Opera:f,Gecko:d,HasAudio:g,BaseZIndex:e,onload:Y,onprogress:J,$:R,randomSelect:D,dataUrl:_,escapeXml:x,Base64:k,PonyINI:L,getOverlay:Ae,parseBoolean:z,parsePoint:M,URL:c}}}()
"undefined"!=typeof BrowserPoniesConfig&&(BrowserPonies.loadConfig(BrowserPoniesConfig),BrowserPoniesConfig.oninit&&!function(){if(Array.isArray(BrowserPoniesConfig.oninit))for(var e=0,t=BrowserPoniesConfig.oninit.length;t>e;++e)BrowserPoniesConfig.oninit[e]()
else BrowserPoniesConfig.oninit()}())}
